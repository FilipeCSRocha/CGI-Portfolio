<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filipe Rocha — CGI Portfolio</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com/3.4.10"></script>

  <!-- Favicon -->
  <link rel="icon" href='data:image/svg+xml,<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%2300e5ff"/><stop offset="1" stop-color="%2380ffea"/></linearGradient></defs><rect width="64" height="64" rx="12" fill="%230a0f12"/><path d="M16 20h22v6H22v6h14v6H22v10h-6z" fill="url(%23g1)"/><path d="M34 20h14c6 0 10 4 10 9 0 4-3 7-7 8l8 11h-8l-7-10h-4v10h-6zM40 26v6h8c2 0 4-1 4-3s-2-3-4-3z" fill="%23e8feff" opacity="0.9"/></svg>' />

  <style>
    html{scroll-behavior:smooth}
    body{background:#0a0f12;color:#fff;margin:0}
    ::-webkit-scrollbar{width:12px;height:12px}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,.03)}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:8px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}
    *{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.25) rgba(255,255,255,.05)}
    #fx{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:0}
    .btn{border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); padding:.5rem 1rem; border-radius:.75rem}
    .btn:hover{background:rgba(255,255,255,.12)}
    .thumb{ filter:grayscale(80%); transition:transform .5s ease, filter .35s ease, opacity .35s ease; }
    .group:hover .thumb, .group.active .thumb{ filter:grayscale(30%); transform:scale(1.04); }

    /* Lightbox visibility flags */
    #lightbox.hidden, #vidLightbox.hidden { display:none; }

    /* Blur-up preview */
    .preview { filter: blur(18px); transform: scale(1.02); }
    .preview.is-ready { filter:none; transform:none; transition: filter .2s ease, transform .2s ease; }

    /* Video overlay for hover preview */
    .thumb-video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity .2s ease; pointer-events:none; }
    .group:hover .thumb-video { opacity:1; }
    @media (hover: none) { .active .thumb-video { opacity:1; } }

    @media (prefers-reduced-motion: reduce) {
      #fx { display:none !important; }
      * { animation:none !important; transition:none !important; }
    }
  </style>
</head>
<body class="min-h-screen selection:bg-cyan-300/20">
  <!-- Background particles -->
  <canvas id="fx"></canvas>

  <!-- HERO -->
  <section class="relative z-10 h-[90svh] overflow-hidden">
    <div class="relative z-10 flex h-full items-center justify-center">
      <div class="mx-4 w-full max-w-3xl rounded-3xl border border-white/10 bg-white/5 p-10 text-center backdrop-blur-xl shadow-[0_0_80px_rgba(0,0,0,0.45)]">
        <h1 class="text-4xl md:text-6xl font-semibold tracking-tight">Filipe Rocha</h1>
        <p class="mt-3 text-lg md:text-xl text-white/80">Senior CGI Visualiser | 20+ Years in ArchViz | 3DS Max Instructor | Freelance &amp; Agency Experience (UK &amp; EU)</p>
        <div class="mt-8 flex items-center justify-center gap-3">
          <a href="#portfolio" class="rounded-xl bg-cyan-400/20 px-5 py-2.5 text-base border border-cyan-300/30 hover:bg-cyan-300/30">View My Work</a>
          <a href="#contact" class="rounded-xl bg-white/5 px-5 py-2.5 text-base border border-white/10 hover:bg-white/10">Contact</a>
        </div>
      </div>
    </div>
    <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/60"></div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="relative z-10 mx-auto max-w-6xl px-6 py-20">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">About Me</h2>
    <div class="grid gap-8 md:grid-cols-[1fr_1.6fr] items-start">
      <div class="flex justify-center">
        <div class="relative w-48 h-48 md:w-56 md:h-56 rounded-full overflow-hidden border border-white/10 shadow-[0_0_40px_rgba(160,240,255,0.25)]">
          <img id="profileImg" src="" alt="Portrait of Filipe Rocha" class="h-full w-full object-cover" />
        </div>
      </div>
      <div class="space-y-8">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-6 leading-relaxed text-white/85 backdrop-blur">
          <p>I’m a CGI artist experienced in design and architectural visualization for marketing.</p>
          <p>I deliver photo-real stills and animations, covering modeling, materials, lighting, rendering, compositing and editing.</p>
          <p>With over 20 years in CGI visualization, I deliver clean, accurate, and market-ready imagery that helps developers and architects present and sell their projects with confidence.</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <h3 class="mb-4 font-medium text-white/90">Tools</h3>
          <div class="space-y-4 mb-5">
            <div>
              <h4 class="text-sm font-semibold text-cyan-300/80 mb-2">Modeling &amp; Rendering</h4>
              <div class="flex flex-wrap gap-2">
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">3ds Max</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">V-Ray</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Corona</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Chaos Vantage</span>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-semibold text-cyan-300/80 mb-2">Procedural / Crowd</h4>
              <div class="flex flex-wrap gap-2">
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Forest Pack</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">RailClone</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Chaos Anima</span>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-semibold text-cyan-300/80 mb-2">Post-Production</h4>
              <div class="flex flex-wrap gap-2">
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Photoshop</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">After Effects</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Premiere Pro</span>
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">DaVinci Resolve</span>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-semibold text-cyan-300/80 mb-2">Real-Time</h4>
              <div class="flex flex-wrap gap-2">
                <span class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs">Unreal Engine</span>
              </div>
            </div>
          </div>
          <div id="toolIcons" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3"></div>
          <p id="toolHint" class="mt-3 text-xs text-white/50 hidden">Place icons as <code>Media/icons/1.png</code>, <code>2.png</code>, …</p>
        </div>
      </div>
    </div>
  </section>

  <!-- STILLS -->
  <section id="portfolio" class="relative z-10 mx-auto max-w-6xl px-6 py-20">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">Stills</h2>
    <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    <div id="galleryActions" class="mt-8 flex justify-center">
      <button id="toggleImages" class="btn">Show more</button>
    </div>
  </section>

  <!-- VIDEOS -->
  <section id="videos" class="relative z-10 mx-auto max-w-6xl px-6 py-20">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">Videos</h2>
    <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    <div id="videoActions" class="mt-8 flex justify-center">
      <button id="toggleVideos" class="btn">Show more</button>
    </div>
  </section>

  <!-- RESUME -->
  <section id="resume" class="relative z-10 mx-auto max-w-6xl px-6 pb-24">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">Resume</h2>
    <div class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
      <ul class="space-y-5">
        <li class="grid gap-2 md:grid-cols-[1.2fr_1fr]">
          <div>
            <div class="text-white/95 font-medium">CGI Artist</div>
            <div class="text-white/70 text-sm">Trident Marketing Anglia Ltd · Ipswich, UK</div>
          </div>
          <div class="text-white/60 text-sm md:text-right"><time datetime="2022-02">Feb 2022</time> – Present</div>
        </li>
        <li class="grid gap-2 md:grid-cols-[1.2fr_1fr]">
          <div>
            <div class="text-white/95 font-medium">CGI Artist</div>
            <div class="text-white/70 text-sm">ThinkBDW · Colchester/Remote, UK</div>
          </div>
          <div class="text-white/60 text-sm md:text-right"><time datetime="2021">2021</time></div>
        </li>
        <li class="grid gap-2 md:grid-cols-[1.2fr_1fr]">
          <div>
            <div class="text-white/95 font-medium">Various positions in CGI, teaching, 3D Printing.</div>
            <div class="text-white/70 text-sm">Euro RSCG, RAM Peripherals, Mx Visualisation, LX3D, teaching at NESCOT and others · UK/Portugal</div>
          </div>
          <div class="text-white/60 text-sm md:text-right"><time datetime="2004">2004</time>–<time datetime="2019">2019</time></div>
        </li>
      </ul>
    </div>
  </section>

  <!-- CONTACT -->
  <footer id="contact" class="relative z-10 border-t border-white/10 bg-white/5">
    <div class="mx-auto max-w-6xl px-6 py-12">
      <div class="grid gap-4 md:grid-cols-2 items-center">
        <div><h3 class="text-xl font-semibold">Let’s work together</h3></div>
        <div class="flex justify-start md:justify-end gap-3">
          <a class="btn" href="mailto:hello@example.com" rel="noopener">Email</a>
          <a class="btn" href="https://www.linkedin.com/in/filipecsrocha/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
        </div>
      </div>
      <p class="mt-6 text-xs text-white/50">© <span id="year"></span> Filipe Rocha. All rights reserved.</p>
    </div>
  </footer>

  <!-- ==== LIGHTBOXES ==== -->
  <!-- IMAGE LIGHTBOX -->
  <div id="lightbox" class="fixed inset-0 hidden z-[2147483647]" aria-hidden="true">
    <div class="absolute inset-0 bg-black/90"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
      <button id="lbClose" class="absolute top-4 right-4 btn" aria-label="Close image">✕ Close</button>
      <button id="lbPrev" class="absolute left-4 top-1/2 -translate-y-1/2 btn" aria-label="Previous image">⟵ Prev</button>
      <button id="lbNext" class="absolute right-4 top-1/2 -translate-y-1/2 btn" aria-label="Next image">Next ⟶</button>
      <button id="lbFull" class="absolute bottom-4 right-4 btn" aria-label="Fullscreen image">⛶ Fullscreen</button>

      <!-- Preview swaps to sharp when full image is loaded -->
      <img id="lbImg" src="" alt="Portfolio image"
           class="block max-w-[92vw] max-h-[90vh] object-contain rounded-2xl border border-white/10 shadow-[0_0_40px_rgba(0,0,0,0.5)] preview" />
    </div>
  </div>

  <!-- VIDEO LIGHTBOX -->
  <div id="vidLightbox" class="fixed inset-0 z-[2147483646] hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/90"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
      <button id="vlbClose" class="absolute top-4 right-4 btn" aria-label="Close video">✕ Close</button>
      <video id="vlbVideo"
             class="block max-w-[92vw] max-h-[90vh] rounded-2xl border border-white/10 shadow-[0_0_40px_rgba(0,0,0,0.5)]"
             controls playsinline preload="metadata"></video>
    </div>
  </div>

<script>
/* ===== Year ===== */
document.getElementById('year').textContent = new Date().getFullYear();

/* ================= Tiny helpers ================= */
async function headExists(url){
  try { const r = await fetch(url, { method: 'HEAD', cache: 'no-store' }); return r.ok; }
  catch { return false; }
}
function probeImage(url){
  return new Promise(function(res){
    const im = new Image();
    im.onload = ()=>res(true);
    im.onerror = ()=>res(false);
    im.src = url;
  });
}
function extOf(name){ const m = name.match(/\.([a-z0-9]+)$/i); return m?m[1].toLowerCase():""; }
function baseOf(name){ return name.replace(/\.[^.]+$/, ""); }

/* ================= BACKGROUND PARTICLES (unchanged visual) ================= */
(function(){
  const canvas = document.getElementById('fx'), ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const PARTICLE_RADIUS = 6, COUNT = 12, BASE_RADIUS = 220, STIFFNESS = 15.0, DAMPING = 0.88, SWIRL = 2,
        LINK_DIST = 190, GRID_ALPHA = 0.055, GRID_SPACING = 96, NOISE = 180, CLICK_IMPULSE = 1200;
  let anchor = { x: innerWidth * .5, y: innerHeight * .45 };
  let mouse  = { x: anchor.x, y: anchor.y, active: false };
  let pts=[]; let state={ scatter:.2 };
  let glow = document.createElement('canvas');

  (function buildGlow(){
    const r = PARTICLE_RADIUS; glow.width = glow.height = r * DPR * 2;
    const g = glow.getContext('2d'); g.setTransform(DPR,0,0,DPR,0,0);
    const grad = g.createRadialGradient(r,r,0,r,r,r);
    grad.addColorStop(0,'rgba(160,240,255,0.95)'); grad.addColorStop(1,'rgba(160,240,255,0)');
    g.fillStyle = grad; g.beginPath(); g.arc(r,r,r,0,Math.PI*2); g.fill();
  })();
  function size(){ const w=Math.max(1,Math.floor(innerWidth)), h=Math.max(1,Math.floor(innerHeight));
    canvas.width=w*DPR; canvas.height=h*DPR; ctx.setTransform(DPR,0,0,DPR,0,0); }
  function spawn(){
    const cw=Math.max(1,Math.floor(innerWidth)), ch=Math.max(1,Math.floor(innerHeight)); pts.length=0;
    for (let i=0;i<COUNT;i++){
      let sx,sy,edge=Math.floor(Math.random()*4);
      if (edge===0){ sx=-20; sy=Math.random()*ch; }
      if (edge===1){ sx=cw+20; sy=Math.random()*ch; }
      if (edge===2){ sx=Math.random()*cw; sy=-20; }
      if (edge===3){ sx=Math.random()*cw; sy=ch+20; }
      let a=Math.random()*Math.PI*2, r=(0.4+Math.random()*0.6)*BASE_RADIUS;
      let toAx=anchor.x-sx, toAy=anchor.y-sy, dist=Math.hypot(toAx,toAy)||1, iv=180+Math.random()*180;
      pts.push({ x:sx,y:sy,vx:(toAx/dist)*iv,vy:(toAy/dist)*iv,homeA:a,homeR:r,swirl:(0.3+Math.random()*0.7)*SWIRL });
    }
  }
  function onMove(e){ mouse.x=e.clientX; mouse.y=e.clientY; mouse.active=true; }
  function onLeave(){ mouse.active=false; }
  function onClick(e){
    const cx=e.clientX, cy=e.clientY; state.scatter=Math.min(1.5,state.scatter+1.0);
    for (const p of pts){ const dx=p.x-cx, dy=p.y-cy, d=Math.hypot(dx,dy)+0.001, ux=dx/d, uy=dy/d, imp=CLICK_IMPULSE*(0.6+0.4*Math.random());
      p.vx+=ux*imp; p.vy+=uy*imp; }
  }
  const footerEl = document.getElementById('contact');
  function getFade(){
    if (!footerEl) return 1; const rect=footerEl.getBoundingClientRect(); const vh=innerHeight||document.documentElement.clientHeight;
    const start=vh, end=vh*0.4; if (rect.top>=start) return 1; if (rect.top<=end) return 0; return (rect.top-end)/(start-end);
  }
  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.05,(now-last)/1000); last=now;
    const cw=Math.max(1,Math.floor(innerWidth)), ch=Math.max(1,Math.floor(innerHeight));
    const kAnchor=12; const tx=mouse.active?mouse.x:anchor.x, ty=mouse.active?mouse.y:anchor.y;
    anchor.x += (tx - anchor.x) * Math.min(1, kAnchor*dt);
    anchor.y += (ty - anchor.y) * Math.min(1, kAnchor*dt);
    if (state.scatter>0) state.scatter=Math.max(0,state.scatter-1.2*dt);
    ctx.clearRect(0,0,cw,ch);
    let fade=getFade(); ctx.save(); ctx.globalAlpha = fade;

    // grid
    ctx.save(); ctx.globalAlpha*=GRID_ALPHA; ctx.lineWidth=1; ctx.strokeStyle='#7fd0ff';
    const ox=((anchor.x/cw)-0.5)*8, oy=((anchor.y/ch)-0.5)*8;
    for (let x=(ox%GRID_SPACING)-GRID_SPACING; x<cw+GRID_SPACING; x+=GRID_SPACING){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ch); ctx.stroke(); }
    for (let y=(oy%GRID_SPACING)-GRID_SPACING; y<ch+GRID_SPACING; y+=GRID_SPACING){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cw,y); ctx.stroke(); }
    ctx.restore();

    // cluster
    const damping=Math.pow(DAMPING, dt*60);
    for (const p of pts){
      p.homeA += p.swirl * 0.3 * dt;
      const targetR = p.homeR * (1 + state.scatter*1.4);
      const px = anchor.x + Math.cos(p.homeA) * targetR;
      const py = anchor.y + Math.sin(p.homeA) * targetR;
      const ax = (px - p.x)*STIFFNESS + (Math.random()-0.5)*NOISE*dt;
      const ay = (py - p.y)*STIFFNESS + (Math.random()-0.5)*NOISE*dt;
      p.vx = (p.vx + ax*dt) * damping;
      p.vy = (p.vy + ay*dt) * damping;
      p.x += p.vx * dt; p.y += p.vy * dt;
    }

    // draw
    for (let i=0;i<pts.length;i++){
      const p=pts[i];
      ctx.drawImage(glow, (p.x-PARTICLE_RADIUS), (p.y-PARTICLE_RADIUS), PARTICLE_RADIUS*2, PARTICLE_RADIUS*2);
      for (let j=i+1;j<pts.length;j++){
        const q=pts[j], dx=p.x-q.x, dy=p.y-q.y, d=Math.hypot(dx,dy);
        if (d<LINK_DIST){ const a=(1-d/LINK_DIST)*0.6; ctx.strokeStyle='rgba(160,240,255,'+a+')'; ctx.lineWidth=.8;
          ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke(); }
      }
    }
    ctx.restore();
    requestAnimationFrame(loop);
  }
  function init(){ addEventListener('resize', size, {passive:true}); size(); spawn(); requestAnimationFrame(loop);
    addEventListener('mousemove', onMove, {passive:true}); addEventListener('mouseleave', onLeave, {passive:true}); addEventListener('click', onClick); }
  init();
})();

/* ================= PROFILE ================= */
(async function(){
  const candidates = [
    "Media/images/Profile.jpg","Media/images/Profile.JPG","Media/images/Profile.jpeg","Media/images/Profile.JPEG",
    "Media/images/profile.jpg","Media/images/profile.JPG","Media/images/profile.jpeg","Media/images/profile.JPEG"
  ];
  let src = "";
  for (const c of candidates){ if (await probeImage(c)) { src = c; break; } }
  if (!src) src = "Media/images/01.jpg";
  const el = document.getElementById('profileImg'); if (el) { el.decoding="async"; el.loading="lazy"; el.src = src; }
})();

/* ================= TOOLS ICONS (icon above label) ================= */
(function(){
  const ICON_MAX = 12;
  const ICON_EXTS = ["png","PNG"];
  const LABELS = {
    1: "3ds Max", 2: "V-Ray", 3: "Corona", 4: "Vantage", 5: "Anima", 6: "Forest Pack",
    7: "RailClone", 8: "Photoshop", 9: "After Effects", 10: "Premiere Pro", 11: "DaVinci Resolve", 12: "Unreal Engine"
  };
  const toolIconsEl = document.getElementById('toolIcons');

  async function findIcon(n){
    for (const ext of ICON_EXTS){ const p = `Media/icons/${n}.${ext}`; if (await headExists(p)) return p; }
    return null;
  }

  (async function load(){
    let any=false, missing=0;
    for (let n=1;n<=ICON_MAX;n++){
      const src = await findIcon(n);
      const label = LABELS[n] || ("Tool " + n);
      if (src){
        any=true;
        const wrap = document.createElement('div');
        wrap.className = "group flex flex-col items-center justify-center gap-2 rounded-xl border border-white/10 bg-white/5 p-3 hover:bg-white/10 transition text-center";

        const img = document.createElement('img');
        img.src = src; img.alt = label; img.className = "h-10 w-10 object-contain"; img.decoding="async"; img.loading="lazy";

        const caption = document.createElement('div');
        caption.className = "text-xs text-white/85";
        caption.textContent = label;

        wrap.appendChild(img);
        wrap.appendChild(caption);
        toolIconsEl.appendChild(wrap);
      } else {
        missing++;
      }
    }

    const hint = document.getElementById('toolHint');
    if (!any) hint.classList.remove('hidden');
    else if (missing>0){ hint.textContent = `Tip: ${missing} icon${missing>1?'s':''} missing. Place files like Media/icons/1.png, 2.png, …`; hint.classList.remove('hidden'); }
  })();
})();

/* ==================== IMAGE GALLERY (speed-focused) ==================== */
(function() {
  const galleryEl = document.getElementById('gallery');
  const toggleBtn = document.getElementById('toggleImages');
  const PAGE_SIZE = 6;

  let entries = [];   // [{file, thumb, lqip}]
  let expanded = false;
  let current = 0;

  async function loadListTxt() {
    const res = await fetch("Media/images/List.txt", { cache: "no-store" });
    if (!res.ok) throw new Error("List.txt not found");
    const text = await res.text();
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
      .filter(f => !/^profile\.(?:jpe?g)$/i.test(f));
  }

  async function buildEntries(files){
    const checks = files.map(async f => {
      const full = `Media/images/${f}`;
      const fname = f;
      const thumbPath = `Media/images/thumbs/${fname}`;
      const lqipPath  = `Media/images/lqip/${fname}`;
      const thumb = (await headExists(thumbPath)) ? thumbPath : full;
      const lqip  = (await headExists(lqipPath))  ? lqipPath  : thumb;
      return { file: fname, thumb, lqip };
    });
    return Promise.all(checks);
  }

  function makeCard(entry, idx) {
    const btn = document.createElement('button');
    btn.className = "group relative aspect-[4/3] overflow-hidden rounded-2xl border border-white/10 bg-white/5 focus:outline-none";
    btn.setAttribute('data-index', idx);
    btn.setAttribute('aria-label', 'Open image ' + (idx+1));
    btn.title = 'Open image';

    const img = document.createElement('img');
    img.src = entry.thumb;
    img.loading = "lazy";
    img.decoding = "async";
    img.setAttribute('fetchpriority','low');
    img.setAttribute('width','1600'); img.setAttribute('height','1200');
    img.srcset = `${entry.thumb} 800w, ${entry.thumb} 1200w, ${entry.thumb} 1600w`;
    img.sizes = "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw";
    img.className = "thumb h-full w-full object-cover";

    const glow = document.createElement('div');
    glow.className = "pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition duration-300 bg-gradient-to-tr from-cyan-300/10 via-transparent to-transparent";

    const badge = document.createElement('div');
    badge.className = "pointer-events-none absolute inset-0 flex items-end justify-end p-3 opacity-0 group-hover:opacity-100 transition";
    const badgeSpan = document.createElement('span');
    badgeSpan.className = "rounded-full border border-white/30 bg-black/30 backdrop-blur px-2 py-0.5 text-xs";
    badgeSpan.textContent = "View";
    badge.appendChild(badgeSpan);

    btn.appendChild(img); btn.appendChild(glow); btn.appendChild(badge);
    btn.addEventListener('click', openLightbox);
    return btn;
  }

  function render() {
    galleryEl.innerHTML = "";
    const toShow = expanded ? entries.length : Math.min(PAGE_SIZE, entries.length);
    for (let i = 0; i < toShow; i++) galleryEl.appendChild(makeCard(entries[i], i));
    toggleBtn.textContent = expanded ? "Show less" : "Show more";
    document.getElementById('galleryActions').classList.toggle('hidden', entries.length <= PAGE_SIZE);
    refreshActiveCentered();
  }

  // ------------- Lightbox (fast & robust) -------------
  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lbImg');
  const lbClose = document.getElementById('lbClose');
  const lbPrev = document.getElementById('lbPrev');
  const lbNext = document.getElementById('lbNext');
  const lbFull = document.getElementById('lbFull');

  function dprRounded(){ const d = Math.min(3, window.devicePixelRatio || 1); return d < 1.5 ? 1 : d < 2.5 ? 2 : 3; }

  // Prefer AVIF/WebP if they exist; otherwise original
  async function bestFormatPath(path){
    const b = baseOf(path);
    const avif = b + ".avif";
    const webp = b + ".webp";
    if (await headExists(`Media/images/${avif}`)) return `Media/images/${avif}`;
    if (await headExists(`Media/images/${webp}`)) return `Media/images/${webp}`;
    return `Media/images/${path}`;
  }

  async function setImageSrc(){
    const entry = entries[current];
    // show instant preview (LQIP or thumb)
    lbImg.classList.remove('is-ready');
    lbImg.src = entry.lqip;
    lbImg.setAttribute('fetchpriority','high'); // prioritize the lightbox image element itself

    // choose best format (avif/webp/jpg) for the same filename
    const hiUrl = await bestFormatPath(entry.file);

    // start high-res load in background
    const hi = new Image();
    hi.fetchPriority = "high";
    // Size hint helps browsers pick better decoders; not required but harmless
    hi.decoding = "sync";
    hi.src = hiUrl;

    hi.onload = () => {
      // swap to sharp
      lbImg.src = hi.src;
      lbImg.classList.add('is-ready');
      // prefetch the likely next image quietly
      const nextIndex = (current + 1) % entries.length;
      prefetchIndex(nextIndex);
    };
    hi.onerror = () => {
      // retry once with cache-bust (GitHub Pages sometimes stalls)
      const bust = hiUrl + (hiUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
      const retry = new Image();
      retry.fetchPriority = "high";
      retry.src = bust;
      retry.onload = () => { lbImg.src = retry.src; lbImg.classList.add('is-ready'); };
      retry.onerror = () => {
        // keep preview but mark as ready to remove blur
        lbImg.classList.add('is-ready');
      };
    };
  }

  async function prefetchIndex(i){
    if (!entries.length) return;
    const e = entries[i];
    const url = await bestFormatPath(e.file);
    const im = new Image();
    im.fetchPriority = "low";
    im.decoding = "async";
    im.src = url;
  }

  function openLightbox(e) {
    current = parseInt(e.currentTarget.getAttribute('data-index'), 10) || 0;
    lb.classList.remove('hidden');
    lb.setAttribute('role','dialog'); lb.setAttribute('aria-modal','true');
    document.body.style.overflow = "hidden";
    setImageSrc();
    lbClose.focus();
  }
  function closeLightbox(){
    lb.classList.add('hidden');
    lb.removeAttribute('role'); lb.removeAttribute('aria-modal');
    document.body.style.overflow = "";
    if (document.fullscreenElement) { try { document.exitFullscreen(); } catch(_) {} }
  }
  function show(delta){
    current = (current + delta + entries.length) % entries.length;
    setImageSrc();
  }
  lbClose.addEventListener('click', closeLightbox);
  lbPrev.addEventListener('click', ()=>show(-1));
  lbNext.addEventListener('click', ()=>show(1));
  window.addEventListener('keydown', e=>{
    if (lb.classList.contains('hidden')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') show(-1);
    if (e.key === 'ArrowRight') show(1);
  });

  // Focus trap + swipe + fullscreen
  (function(){
    function focusables(){
      return Array.from(lb.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])')).filter(el=>!el.disabled);
    }
    lb.addEventListener('keydown', (e)=>{
      if (e.key !== 'Tab' || lb.classList.contains('hidden')) return;
      const f = focusables(); if (!f.length) return;
      const first = f[0], last = f[f.length-1];
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    });
    let sx=0, sy=0, dx=0, dy=0, active=false;
    lb.addEventListener('touchstart', (e)=>{ if (lb.classList.contains('hidden')) return;
      if (!e.touches[0]) return; active=true; sx=e.touches[0].clientX; sy=e.touches[0].clientY; dx=dy=0; }, { passive:true });
    lb.addEventListener('touchmove', (e)=>{ if (!active || !e.touches[0]) return; dx=e.touches[0].clientX - sx; dy=e.touches[0].clientY - sy; }, { passive:true });
    lb.addEventListener('touchend', ()=>{ if (!active) return; active=false; if (Math.abs(dx)>60 && Math.abs(dy)<80){ show(dx>0 ? -1 : 1); } });
    lbFull.addEventListener('click', async ()=>{ try { if (!document.fullscreenElement) await lbImg.requestFullscreen(); else await document.exitFullscreen(); } catch(e){} });
  })();

  toggleBtn.addEventListener('click', function(){ expanded = !expanded; render(); });

  (async function init(){
    try {
      const files = await loadListTxt();
      if (!files.length) {
        galleryEl.innerHTML = '<div class="rounded-xl border border-white/10 bg-white/5 p-6 text-white/70">Images coming soon.</div>';
        document.getElementById('galleryActions').classList.add('hidden');
        return;
      }
      entries = await buildEntries(files);
      render();
    } catch (err) {
      console.warn('[Images] ' + err.message);
      galleryEl.innerHTML = '<div class="rounded-xl border border-white/10 bg-white/5 p-6 text-white/70">Images coming soon.</div>';
      document.getElementById('galleryActions').classList.add('hidden');
    }
  })();
})();

/* ==================== VIDEOS (snappier start) ==================== */
(function(){
  const videoGrid = document.getElementById('videoGrid');
  const toggleBtn = document.getElementById('toggleVideos');
  const PAGE = 6;

  let files = [];
  let expanded = false;

  async function loadListTxt() {
    const res = await fetch("Media/videos/List.txt", { cache: "no-store" });
    if (!res.ok) throw new Error("Videos List.txt not found");
    const text = await res.text();
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  function card(src, idx){
    const btn = document.createElement('button');
    btn.className = "group relative aspect-[4/3] overflow-hidden rounded-2xl border border-white/10 bg-white/5 focus:outline-none";
    btn.setAttribute('data-vidindex', idx);
    btn.setAttribute('aria-label', 'Play video ' + (idx+1));
    btn.title = 'Play video';

    // Poster image (always visible)
    const poster = document.createElement('img');
    poster.src = src.replace(/\.\w+$/, '.jpg');
    poster.alt = "Video thumbnail";
    poster.loading = "lazy";
    poster.decoding = "async";
    poster.className = "thumb h-full w-full object-cover";

    // Hover/touch preview: lightweight (metadata only) until play() is called
    const vid = document.createElement('video');
    vid.className = "thumb-video";
    vid.muted = true; vid.playsInline = true; vid.loop = true; vid.preload = "metadata";

    const source = document.createElement('source');
    source.src = src; source.type = "video/mp4";
    vid.appendChild(source);

    // Hover preview (desktop)
    btn.addEventListener('mouseenter', ()=>{
      if (!matchMedia('(hover: hover)').matches) return;
      try { vid.currentTime = 0; } catch(_) {}
      vid.play().catch(()=>{});
    });
    btn.addEventListener('mouseleave', ()=>{
      if (!matchMedia('(hover: hover)').matches) return;
      try { vid.pause(); vid.currentTime = 0; } catch(_) {}
    });

    const glow = document.createElement('div');
    glow.className = "pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition duration-300 bg-gradient-to-tr from-cyan-300/10 via-transparent to-transparent";

    btn.appendChild(poster);
    btn.appendChild(vid);
    btn.appendChild(glow);

    btn.addEventListener('click', openLightbox);
    return btn;
  }

  function render(){
    videoGrid.innerHTML = "";
    const toShow = expanded ? files.length : Math.min(PAGE, files.length);
    for (let i=0; i<toShow; i++){ videoGrid.appendChild(card(`Media/videos/${files[i]}`, i)); }
    toggleBtn.textContent = expanded ? "Show less" : "Show more";
    document.getElementById('videoActions').classList.toggle('hidden', files.length <= PAGE);
    refreshActiveCentered();
  }

  // Lightbox
  const vlb = document.getElementById('vidLightbox');
  const vlbVideo = document.getElementById('vlbVideo');
  const vlbClose = document.getElementById('vlbClose');
  let current = 0;

  function openLightbox(e){
    const btn = e.currentTarget;
    current = parseInt(btn.getAttribute('data-vidindex'), 10) || 0;

    const filename = files[current];
    try { vlbVideo.pause(); } catch(_) {}
    vlbVideo.removeAttribute('src'); vlbVideo.innerHTML = ""; vlbVideo.removeAttribute('poster');

    // use poster to show something instantly
    vlbVideo.poster = `Media/videos/${filename.replace(/\.\w+$/, '.jpg')}`;
    const mp4  = document.createElement('source'); mp4.src  = `Media/videos/${filename}`; mp4.type = "video/mp4";
    vlbVideo.appendChild(mp4);

    vlb.classList.remove('hidden');
    vlb.setAttribute('aria-hidden','false'); vlb.setAttribute('role','dialog'); vlb.setAttribute('aria-modal','true');
    document.body.style.overflow = "hidden";

    vlbVideo.currentTime = 0;
    // Start only now to save bandwidth
    vlbVideo.play().catch(()=>{});
    vlbClose.focus();
  }

  function closeLightbox(){
    vlb.classList.add('hidden');
    vlb.setAttribute('aria-hidden','true'); vlb.removeAttribute('role'); vlb.removeAttribute('aria-modal');
    document.body.style.overflow = "";
    try { vlbVideo.pause(); } catch(_) {}
    vlbVideo.removeAttribute('src'); vlbVideo.removeAttribute('poster'); vlbVideo.innerHTML = "";
    try { vlbVideo.load(); } catch(_) {}
  }

  vlbClose.addEventListener('click', closeLightbox);
  vlb.addEventListener('click', (e)=>{ if(e.target === vlb || e.target.classList.contains('bg-black/90')) closeLightbox(); });
  window.addEventListener('keydown', (e)=>{ if (!vlb.classList.contains('hidden') && e.key === 'Escape') closeLightbox(); });

  toggleBtn.addEventListener('click', ()=>{ expanded = !expanded; render(); });

  (async function init(){
    try {
      files = await loadListTxt();
      if (!files.length){
        videoGrid.innerHTML = '<div class="rounded-xl border border-white/10 bg-white/5 p-6 text-white/70">Videos coming soon.</div>';
        document.getElementById('videoActions').classList.add('hidden');
        return;
      }
      render();
    } catch (err) {
      console.warn('[Videos] ' + err.message);
      videoGrid.innerHTML = '<div class="rounded-xl border border-white/10 bg-white/5 p-6 text-white/70">Videos coming soon.</div>';
      document.getElementById('videoActions').classList.add('hidden');
    }
  })();
})();

/* ================= CENTERED-ITEM "ACTIVE" LOGIC ================= */
(function(){
  const gallery = document.getElementById('gallery');
  const videoGrid = document.getElementById('videoGrid');
  let ticking = false;

  function setActive(container){
    if (!container) return;
    const items = Array.from(container.children);
    if (!items.length) return;
    items.forEach(el => el.classList.remove('active'));

    const vy = innerHeight / 2; let best=null, bestDist=Infinity;
    for (const el of items){
      const r = el.getBoundingClientRect();
      if (r.height <= 0 || r.bottom < 0 || r.top > innerHeight) continue;
      const cy = (r.top + r.bottom) / 2, d = Math.abs(cy - vy);
      if (d < bestDist){ bestDist=d; best=el; }
    }
    if (!best) return;
    best.classList.add('active');

    const isHoverCapable = matchMedia('(hover: hover)').matches;
    if (container === videoGrid){
      if (!isHoverCapable) {
        for (const el of items){
          const v = el.querySelector('video'); if (!v) continue;
          if (el === best){ try { v.currentTime = 0; } catch(_) {} v.play().catch(()=>{}); }
          else { try { v.pause(); v.currentTime=0; } catch(_) {} }
        }
      } else {
        for (const el of items){ const v = el.querySelector('video'); if (!v) continue; try { v.pause(); v.currentTime=0; } catch(_) {} }
      }
    }
  }
  function refresh(){
    const isHoverCapable = matchMedia('(hover: hover)').matches;
    const oneColumn = matchMedia('(max-width: 639px)').matches;

    if (oneColumn) setActive(gallery);
    else if (gallery){ Array.from(gallery.children).forEach(el=>el.classList.remove('active')); }

    if (!isHoverCapable) setActive(videoGrid);
    else if (oneColumn) setActive(videoGrid);
    else if (videoGrid){
      Array.from(videoGrid.children).forEach(el=>{
        el.classList.remove('active'); const v = el.querySelector('video'); if (v){ v.pause(); try { v.currentTime=0; } catch(_) {} }
      });
    }
  }
  window.refreshActiveCentered = refresh;

  function onScrollOrResize(){ if (ticking) return; ticking=true; requestAnimationFrame(()=>{ refresh(); ticking=false; }); }
  addEventListener('scroll', onScrollOrResize, { passive:true });
  addEventListener('resize', onScrollOrResize, { passive:true });
  addEventListener('orientationchange', onScrollOrResize);
})();

/* ================= Misc ================= */
document.addEventListener('visibilitychange', ()=>{
  document.querySelectorAll('#videoGrid video').forEach(v=>{ if (document.hidden) v.pause(); });
});
</script>
</body>
</html>
