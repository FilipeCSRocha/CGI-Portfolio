<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filipe Rocha — CGI Portfolio</title>

  <!-- Tailwind (unchanged). Replace with compiled CSS when ready. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon (unchanged) -->
  <link rel="icon" type="image/png" href="Media/icons/1.png" />

  <style>
    html{scroll-behavior:smooth}
    body{background:#0a0f12;color:#fff;margin:0}
    ::-webkit-scrollbar{width:12px;height:12px}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,.03)}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:8px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}
    *{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.25) rgba(255,255,255,.05)}
    #fx{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:0}
    .btn{border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); padding:.5rem 1rem; border-radius:.75rem}
    .btn:hover{background:rgba(255,255,255,.12)}
    .thumb{ filter:grayscale(80%); transition:transform .5s ease, filter .35s ease, opacity .35s ease; }
    /* Hover visuals also apply when the card is 'active' (used for mobile centered item) */
    .group:hover .thumb, .group.active .thumb{ filter:grayscale(30%); transform:scale(1.04); }
    /* Keep lightboxes hidden until opened */
    #lightbox.hidden, #vidLightbox.hidden { display: none; }
  </style>
</head>
<body class="min-h-screen selection:bg-cyan-300/20">
  <!-- Background particles (unchanged visual) -->
  <canvas id="fx"></canvas>

  <!-- HERO (unchanged) -->
  <section class="relative z-10 h-[90svh] overflow-hidden">
    <video id="heroVideo" class="absolute inset-0 h-full w-full object-cover opacity-55" src="https://cdn.coverr.co/videos/coverr-modern-interior-8050/1080p.mp4" autoplay muted playsinline loop style="z-index:0"></video>
    <div class="relative z-10 flex h-full items-center justify-center">
      <div class="mx-4 w-full max-w-3xl rounded-3xl border border-white/10 bg-white/5 p-10 text-center backdrop-blur-xl shadow-[0_0_80px_rgba(0,0,0,0.45)]">
        <h1 class="text-4xl md:text-6xl font-semibold tracking-tight">Filipe Rocha</h1>
        <p class="mt-3 text-lg md:text-xl text-white/80">CGI Artist</p>
        <div class="mt-8 flex items-center justify-center gap-3">
          <a href="#portfolio" class="rounded-xl bg-cyan-400/20 px-5 py-2.5 text-base border border-cyan-300/30 hover:bg-cyan-300/30">View My Work</a>
          <a href="#contact" class="rounded-xl bg-white/5 px-5 py-2.5 text-base border border-white/10 hover:bg-white/10">Contact</a>
        </div>
      </div>
    </div>
    <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/60"></div>
  </section>

  <!-- ABOUT (unchanged content) -->
  <section id="about" class="relative z-10 mx-auto max-w-6xl px-6 py-20">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">About Me</h2>
    <div class="grid gap-8 md:grid-cols-[1fr_1.6fr] items-start">
      <div class="flex justify-center">
        <div class="relative w-48 h-48 md:w-56 md:h-56 rounded-full overflow-hidden border border-white/10 shadow-[0_0_40px_rgba(160,240,255,0.25)]">
          <img id="profileImg" src="" alt="Filipe Rocha" class="h-full w-full object-cover" />
        </div>
      </div>
      <div class="space-y-8">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-6 leading-relaxed text-white/85 backdrop-blur">
          I’m a CGI artist experienced in design and architectural visualization for marketing.
          I deliver photo-real stills and animations, covering modeling, materials, lighting, rendering, compositing and editing.
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <h3 class="mb-4 font-medium text-white/90">Tools</h3>
          <div id="toolIcons" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3"></div>
          <p id="toolHint" class="mt-3 text-xs text-white/50 hidden">Place icons as <code>Media/icons/1.png</code>, <code>2.png</code>, …</p>
        </div>
      </div>
    </div>
  </section>

  <!-- PORTFOLIO (unchanged markup; behavior tweaked below) -->
  <section id="portfolio" class="relative z-10 mx-auto max-w-6xl px-6 py-20">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">Portfolio</h2>
    <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    <div id="galleryActions" class="mt-8 flex justify-center">
      <button id="toggleImages" class="btn">Show more</button>
    </div>
  </section>

  <!-- VIDEOS (unchanged markup; behavior tweaked below) -->
  <section id="videos" class="relative z-10 mx-auto max-w-6xl px-6 py-20">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">Videos</h2>
    <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    <div id="videoActions" class="mt-8 flex justify-center">
      <button id="toggleVideos" class="btn">Show more</button>
    </div>
    <div id="vidLightbox" class="fixed inset-0 z-[9999] hidden" aria-hidden="true">
      <div class="absolute inset-0 bg-black/90"></div>
      <div class="relative h-full w-full flex items-center justify-center p-4">
        <button id="vlbClose" class="absolute top-4 right-4 btn" aria-label="Close video">✕ Close</button>
        <button id="vlbPrev" class="absolute left-4 top-1/2 -translate-y-1/2 btn" aria-label="Previous video">⟵ Prev</button>
        <button id="vlbNext" class="absolute right-4 top-1/2 -translate-y-1/2 btn" aria-label="Next video">Next ⟶</button>
        <video id="vlbVideo" src="" class="block max-w-[92vw] max-h-[90vh] rounded-2xl border border-white/10 shadow-[0_0_40px_rgba(0,0,0,0.5)]" controls playsinline></video>
      </div>
    </div>
  </section>

  <!-- RESUME (unchanged) -->
  <section id="resume" class="relative z-10 mx-auto max-w-6xl px-6 pb-24">
    <h2 class="mb-6 text-2xl md:text-3xl font-semibold tracking-tight">Resume</h2>
    <div class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
      <ul class="space-y-5">
        <li class="grid gap-2 md:grid-cols-[1.2fr_1fr]">
          <div>
            <div class="text-white/95 font-medium">CGI Artist</div>
            <div class="text-white/70 text-sm">Trident Marketing Anglia Ltd · Ipswich, UK</div>
          </div>
          <div class="text-white/60 text-sm md:text-right">Feb 2022 – Present</div>
        </li>
        <li class="grid gap-2 md:grid-cols-[1.2fr_1fr]">
          <div>
            <div class="text-white/95 font-medium">3D Visualiser (Freelance)</div>
            <div class="text-white/70 text-sm">London, UK</div>
          </div>
          <div class="text-white/60 text-sm md:text-right">Jul 2020 – Feb 2022</div>
        </li>
      </ul>
    </div>
  </section>

  <!-- CONTACT (unchanged) -->
  <footer id="contact" class="relative z-10 border-t border-white/10 bg-white/5">
    <div class="mx-auto max-w-6xl px-6 py-12">
      <div class="grid gap-4 md:grid-cols-2 items-center">
        <div>
          <h3 class="text-xl font-semibold">Let’s work together</h3>
          <p class="text-white/70">Available for freelance and collaboration.</p>
        </div>
        <div class="flex justify-start md:justify-end gap-3">
          <a class="btn" href="mailto:hello@example.com">Email</a>
          <a class="btn" href="https://www.linkedin.com/in/filipecsrocha/" target="_blank" rel="noreferrer">LinkedIn</a>
          <a class="btn" href="#" target="_blank" rel="noreferrer">ArtStation</a>
          <a class="btn" href="#" target="_blank" rel="noreferrer">Vimeo</a>
        </div>
      </div>
      <p class="mt-6 text-xs text-white/50">© <span id="year"></span> Filipe Rocha. All rights reserved.</p>
    </div>
  </footer>

  <!-- IMAGE LIGHTBOX (unchanged) -->
  <div id="lightbox" class="fixed inset-0 hidden" style="z-index:2147483647;" aria-hidden="true">
    <div class="absolute inset-0 bg-black/90"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
      <button id="lbClose" class="absolute top-4 right-4 btn" aria-label="Close image">✕ Close</button>
      <button id="lbPrev" class="absolute left-4 top-1/2 -translate-y-1/2 btn" aria-label="Previous image">⟵ Prev</button>
      <button id="lbNext" class="absolute right-4 top-1/2 -translate-y-1/2 btn" aria-label="Next image">Next ⟶</button>
      <img id="lbImg" src="" alt="" class="block max-w-[92vw] max-h-[90vh] object-contain rounded-2xl border border-white/10 shadow-[0_0_40px_rgba(0,0,0,0.5)]" />
    </div>
  </div>

<script>
  // Year (unchanged)
  document.getElementById('year').textContent = new Date().getFullYear();

  /* ================= BACKGROUND PARTICLES (unchanged behavior) ================= */
  (function(){
    var canvas = document.getElementById('fx');
    var ctx = canvas.getContext('2d');
    var DPR = window.devicePixelRatio || 1;

    var PARTICLE_RADIUS = 6;
    var COUNT = 12;
    var BASE_RADIUS = 220;
    var STIFFNESS = 15.0;
    var DAMPING = 0.88;
    var SWIRL = 2;
    var LINK_DIST = 190;
    var GRID_ALPHA = 0.055;
    var GRID_SPACING = 96;
    var NOISE = 180;
    var SPAWN_MODE = 'edges';
    var CLICK_IMPULSE = 1200;

    var anchor = { x: window.innerWidth * 0.5, y: window.innerHeight * 0.45 };
    var mouse  = { x: anchor.x, y: anchor.y, active: false };
    var pts = [];
    var state = { scatter: 0.2 };

    var glow = document.createElement('canvas');
    (function buildGlow(){
      var r = PARTICLE_RADIUS;
      glow.width = glow.height = r * DPR * 2;
      var g = glow.getContext('2d');
      g.setTransform(DPR,0,0,DPR,0,0);
      var grad = g.createRadialGradient(r,r,0,r,r,r);
      grad.addColorStop(0,'rgba(160,240,255,0.95)');
      grad.addColorStop(1,'rgba(160,240,255,0)');
      g.fillStyle = grad;
      g.beginPath(); g.arc(r,r,r,0,Math.PI*2); g.fill();
    })();

    function size(){
      var cssW = Math.max(1, Math.floor(window.innerWidth));
      var cssH = Math.max(1, Math.floor(window.innerHeight));
      canvas.width  = cssW * DPR;
      canvas.height = cssH * DPR;
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }

    function spawn(){
      var cw = Math.max(1, Math.floor(window.innerWidth));
      var ch = Math.max(1, Math.floor(window.innerHeight));
      pts.length = 0;
      for (var i=0; i<COUNT; i++){
        var sx, sy;
        if (SPAWN_MODE === 'center'){ sx = anchor.x; sy = anchor.y; }
        else {
          var edge = Math.floor(Math.random()*4);
          if (edge===0){ sx = -20; sy = Math.random()*ch; }
          if (edge===1){ sx = cw+20; sy = Math.random()*ch; }
          if (edge===2){ sx = Math.random()*cw; sy = -20; }
          if (edge===3){ sx = Math.random()*cw; sy = ch+20; }
        }
        var a = Math.random()*Math.PI*2;
        var r = (0.4 + Math.random()*0.6) * BASE_RADIUS;
        var toAx = anchor.x - sx, toAy = anchor.y - sy;
        var dist = Math.hypot(toAx,toAy) || 1;
        var iv = 180 + Math.random()*180;
        pts.push({ x: sx, y: sy, vx: (toAx/dist)*iv, vy: (toAy/dist)*iv, homeA: a, homeR: r, swirl: (0.3+Math.random()*0.7)*SWIRL });
      }
    }

    function onMove(e){ mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; }
    function onLeave(){ mouse.active = false; }
    function onClick(e){
      var cx = e.clientX, cy = e.clientY;
      state.scatter = Math.min(1.5, state.scatter + 1.0);
      for (var i=0; i<pts.length; i++){
        var p = pts[i];
        var dx = p.x - cx, dy = p.y - cy;
        var d = Math.hypot(dx,dy) + 0.001;
        var uX = dx/d, uY = dy/d;
        var impulse = CLICK_IMPULSE * (0.6 + 0.4*Math.random());
        p.vx += uX * impulse; p.vy += uY * impulse;
      }
    }

    var footerEl = document.getElementById('contact');
    function getFade(){
      if (!footerEl) return 1;
      var rect = footerEl.getBoundingClientRect();
      var vh = window.innerHeight || document.documentElement.clientHeight;
      var start = vh, end = vh * 0.4;
      if (rect.top >= start) return 1;
      if (rect.top <= end) return 0;
      return (rect.top - end) / (start - end);
    }

    var last = performance.now();
    function loop(now){
      var dt = Math.min(0.05, (now - last) / 1000); last = now;
      var cw = Math.max(1, Math.floor(window.innerWidth));
      var ch = Math.max(1, Math.floor(window.innerHeight));

      var kAnchor = 12;
      var tx = mouse.active ? mouse.x : anchor.x;
      var ty = mouse.active ? mouse.y : anchor.y;
      anchor.x += (tx - anchor.x) * Math.min(1, kAnchor*dt);
      anchor.y += (ty - anchor.y) * Math.min(1, kAnchor*dt);

      if (state.scatter > 0) state.scatter = Math.max(0, state.scatter - 1.2*dt);

      ctx.clearRect(0, 0, cw, ch);

      var fade = getFade();
      ctx.save(); ctx.globalAlpha = fade;

      // Grid
      ctx.save(); ctx.globalAlpha *= GRID_ALPHA; ctx.lineWidth = 1; ctx.strokeStyle = '#7fd0ff';
      var ox = ((anchor.x/cw)-0.5)*8, oy = ((anchor.y/ch)-0.5)*8;
      for (var x = (ox % GRID_SPACING) - GRID_SPACING; x < cw + GRID_SPACING; x += GRID_SPACING){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ch); ctx.stroke();
      }
      for (var y = (oy % GRID_SPACING) - GRID_SPACING; y < ch + GRID_SPACING; y += GRID_SPACING){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cw,y); ctx.stroke();
      }
      ctx.restore();

      // Update cluster
      var damping = Math.pow(DAMPING, dt*60);
      for (var i=0; i<pts.length; i++){
        var p = pts[i];
        p.homeA += p.swirl * 0.3 * dt;
        var targetR = p.homeR * (1 + state.scatter*1.4);
        var px = anchor.x + Math.cos(p.homeA) * targetR;
        var py = anchor.y + Math.sin(p.homeA) * targetR;
        var ax = (px - p.x) * STIFFNESS + (Math.random()-0.5) * NOISE * dt;
        var ay = (py - p.y) * STIFFNESS + (Math.random()-0.5) * NOISE * dt;
        p.vx = (p.vx + ax * dt) * damping;
        p.vy = (p.vy + ay * dt) * damping;
        p.x += p.vx * dt; p.y += p.vy * dt;
      }

      // Draw particles + proximity lines
      for (var i=0; i<pts.length; i++){
        var p = pts[i];
        ctx.drawImage(glow, (p.x - PARTICLE_RADIUS), (p.y - PARTICLE_RADIUS), PARTICLE_RADIUS*2, PARTICLE_RADIUS*2);
        for (var j=i+1; j<pts.length; j++){
          var q = pts[j];
          var dx = p.x - q.x, dy = p.y - q.y, d = Math.hypot(dx,dy);
          if (d < LINK_DIST){
            var a = (1 - d/LINK_DIST) * 0.6;
            ctx.strokeStyle = 'rgba(160,240,255,' + a + ')';
            ctx.lineWidth = 0.8;
            ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(q.x, q.y); ctx.stroke();
          }
        }
      }

      ctx.restore();
      requestAnimationFrame(loop);
    }

    function init(){
      window.addEventListener('resize', size, { passive:true });
      size(); spawn(); requestAnimationFrame(loop);
      window.addEventListener('mousemove', onMove, { passive:true });
      window.addEventListener('mouseleave', onLeave, { passive:true });
      window.addEventListener('click', onClick);
      var vid = document.getElementById('heroVideo');
      if (vid){ var p = vid.play(); if (p && p.catch) p.catch(function(){ vid.remove(); }); }
    }
    init();
  })();

  /* ================= SMALL HELPERS (unchanged) ================= */
  async function headExists(url){
    try { const r = await fetch(url, { method: 'HEAD', cache: 'no-store' }); return r.ok; }
    catch { return false; }
  }
  function probeImage(url){
    return new Promise(function(res){
      var im = new Image();
      im.onload = function(){ res(true); };
      im.onerror = function(){ res(false); };
      im.src = url;
    });
  }

  /* ================= PROFILE (unchanged logic) ================= */
  (async function(){
    var candidates = [
      "Media/images/Profile.jpg","Media/images/Profile.JPG","Media/images/Profile.jpeg","Media/images/Profile.JPEG",
      "Media/images/profile.jpg","Media/images/profile.JPG","Media/images/profile.jpeg","Media/images/profile.JPEG"
    ];
    var src = "";
    for (var i=0;i<candidates.length;i++){
      if (await probeImage(candidates[i])) { src = candidates[i]; break; }
    }
    if (!src) src = "Media/images/01.jpg";
    var el = document.getElementById('profileImg'); if (el) el.src = src;
  })();

  /* ================= TOOLS (unchanged behavior) ================= */
  (function(){
    var ICON_MAX = 12;
    var ICON_EXTS = ["png","PNG"];
    var ICON_LABELS = {
      1: "3ds Max", 2: "V-Ray", 3: "Corona", 4: "Vantage", 5: "Anima", 6: "Forest Pack",
      7: "RailClone", 8: "Photoshop", 9: "After Effects", 10: "Premiere Pro", 11: "DaVinci Resolve", 12: "Unreal Engine"
    };
    var toolIconsEl = document.getElementById('toolIcons');
    async function findIcon(n){
      for (var i=0;i<ICON_EXTS.length;i++){
        var src = "Media/icons/" + n + "." + ICON_EXTS[i];
        if (await headExists(src)) return src;
      }
      return null;
    }
    (async function load(){
      var any=false;
      for (var n=1; n<=ICON_MAX; n++){
        var src = await findIcon(n);
        if (src){
          any=true;
          var label = ICON_LABELS[n] || ("Tool " + n);
          var wrap = document.createElement('div');
          wrap.className = "group relative flex items-center justify-center rounded-xl border border-white/10 bg-white/5 px-3 py-2 hover:bg-white/10 transition";
          var img = document.createElement('img');
          img.src = src; img.alt = label; img.className = "h-6 w-6 object-contain";
          wrap.appendChild(img);
          var tip = document.createElement('div');
          tip.className = "pointer-events-none absolute left-1/2 top-full mt-1 -translate-x-1/2 whitespace-nowrap rounded-md border border-white/10 bg-black/80 px-2 py-1 text-xs text-white/90 opacity-0 translate-y-1 group-hover:opacity-100 group-hover:translate-y-0 transition";
          tip.textContent = label;
          var arrow = document.createElement('span');
          arrow.className = "absolute -top-1 left-1/2 -translate-x-1/2 h-2 w-2 rotate-45 border-l border-t border-white/10 bg-black/80";
          tip.appendChild(arrow);
          wrap.appendChild(tip);
          toolIconsEl.appendChild(wrap);
        }
      }
      if (!any) document.getElementById('toolHint').classList.remove('hidden');
    })();
  })();

  /* ================= IMAGES (manifest-driven; unchanged except for 'active' support) ================= */
  (async function() {
    const galleryEl = document.getElementById('gallery');
    const toggleBtn = document.getElementById('toggleImages');
    const PAGE_SIZE = 6;

    let entries = [];   // [{file, thumb}]
    let expanded = false;

    async function loadListTxt() {
      const res = await fetch("Media/images/List.txt", { cache: "no-store" });
      if (!res.ok) throw new Error("List.txt not found");
      const text = await res.text();
      return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
        .filter(f => !/^profile\.(?:jpe?g)$/i.test(f));
    }
    async function buildEntries(files){
      const checks = files.map(async f => {
        const full = `Media/images/${f}`;
        const thumbPath = `Media/images/thumbs/${f}`;
        const thumb = (await headExists(thumbPath)) ? thumbPath : full;
        return { file: f, thumb };
      });
      return Promise.all(checks);
    }

    function makeCard(entry, idx) {
      const btn = document.createElement('button');
      btn.className = "group relative aspect-[4/3] overflow-hidden rounded-2xl border border-white/10 bg-white/5 focus:outline-none";
      btn.setAttribute('data-index', idx);

      const img = document.createElement('img');
      img.src = entry.thumb;
      img.loading = "lazy";
      img.decoding = "async";
      img.className = "thumb h-full w-full object-cover";

      const glow = document.createElement('div');
      glow.className = "pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition duration-300 bg-gradient-to-tr from-cyan-300/10 via-transparent to-transparent";

      const badge = document.createElement('div');
      badge.className = "pointer-events-none absolute inset-0 flex items-end justify-end p-3 opacity-0 group-hover:opacity-100 transition";
      const badgeSpan = document.createElement('span');
      badgeSpan.className = "rounded-full border border-white/30 bg-black/30 backdrop-blur px-2 py-0.5 text-xs";
      badgeSpan.textContent = "View";
      badge.appendChild(badgeSpan);

      btn.appendChild(img); btn.appendChild(glow); btn.appendChild(badge);
      btn.addEventListener('click', openLightbox);
      return btn;
    }

    function render() {
      galleryEl.innerHTML = "";
      const toShow = expanded ? entries.length : Math.min(PAGE_SIZE, entries.length);
      for (let i = 0; i < toShow; i++) galleryEl.appendChild(makeCard(entries[i], i));
      toggleBtn.textContent = expanded ? "Show less" : "Show more";
      document.getElementById('galleryActions').classList.toggle('hidden', entries.length <= PAGE_SIZE);
      refreshActiveCentered(); // ensure correct 'active' after (re)render
    }

    // Image lightbox (unchanged)
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lbImg');
    const lbClose = document.getElementById('lbClose');
    const lbPrev = document.getElementById('lbPrev');
    const lbNext = document.getElementById('lbNext');
    let current = 0;

    function openLightbox(e) {
      current = parseInt(e.currentTarget.getAttribute('data-index'), 10) || 0;
      lbImg.src = `Media/images/${entries[current].file}`;
      lb.classList.remove('hidden');
      document.body.style.overflow = "hidden";
    }
    function closeLightbox(){ lb.classList.add('hidden'); document.body.style.overflow = ""; }
    function show(delta){
      current = (current + delta + entries.length) % entries.length;
      lbImg.src = `Media/images/${entries[current].file}`;
    }
    lbClose.addEventListener('click', closeLightbox);
    lbPrev.addEventListener('click', ()=>show(-1));
    lbNext.addEventListener('click', ()=>show(1));
    window.addEventListener('keydown', e=>{
      if (lb.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') show(-1);
      if (e.key === 'ArrowRight') show(1);
    });

    toggleBtn.addEventListener('click', function(){
      expanded = !expanded;
      render();
    });

    // Init
    try {
      const files = await loadListTxt();
      if (!files.length) { document.getElementById('portfolio').classList.add('hidden'); return; }
      entries = await buildEntries(files);
      render();
    } catch (err) {
      console.warn('[Images] ' + err.message);
      document.getElementById('portfolio').classList.add('hidden');
    }
  })();

  /* ================= VIDEOS (manifest-driven) =================
     Change: previews play on HOVER only (desktop),
             and on MOBILE 1-column the centered card auto-previews.
  ============================================================= */
  (async function(){
    const videoGrid = document.getElementById('videoGrid');
    const toggleBtn = document.getElementById('toggleVideos');
    const PAGE = 6;

    let files = [];
    let expanded = false;

    async function loadListTxt() {
      const res = await fetch("Media/videos/List.txt", { cache: "no-store" });
      if (!res.ok) throw new Error("Videos List.txt not found");
      const text = await res.text();
      return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }

    function card(src, idx){
      const btn = document.createElement('button');
      btn.className = "group relative aspect-[4/3] overflow-hidden rounded-2xl border border-white/10 bg-white/5 focus:outline-none";
      btn.setAttribute('data-vidindex', idx);

      const vid = document.createElement('video');
      vid.src = src;
      vid.className = "thumb h-full w-full object-cover opacity-90";
      vid.muted = true; vid.playsInline = true;
      vid.preload = "metadata";     // <-- no eager buffering; no auto-play
      // Desktop preview on hover only
      btn.addEventListener('mouseenter', ()=>{
        if (window.matchMedia('(hover: hover)').matches) { vid.play().catch(()=>{}); }
      });
      btn.addEventListener('mouseleave', ()=>{
        vid.pause(); try { vid.currentTime = 0; } catch(_) {}
      });

      const badge = document.createElement('div');
      badge.className = "absolute inset-0 grid place-items-center pointer-events-none";
      const span = document.createElement('span');
      span.className = "rounded-full border border-white/50 bg-black/40 backdrop-blur px-3 py-1 text-sm";
      span.textContent = "▶ Play";
      badge.appendChild(span);

      const glow = document.createElement('div');
      glow.className = "pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition duration-300 bg-gradient-to-tr from-cyan-300/10 via-transparent to-transparent";

      btn.appendChild(vid); btn.appendChild(badge); btn.appendChild(glow);
      btn.addEventListener('click', openLightbox);
      return btn;
    }

    function render(){
      videoGrid.innerHTML = "";
      const toShow = expanded ? files.length : Math.min(PAGE, files.length);
      for (let i=0; i<toShow; i++){
        videoGrid.appendChild(card(`Media/videos/${files[i]}`, i));
      }
      toggleBtn.textContent = expanded ? "Show less" : "Show more";
      document.getElementById('videoActions').classList.toggle('hidden', files.length <= PAGE);
      refreshActiveCentered(); // ensure correct 'active' after (re)render
    }

    // Lightbox (unchanged except autoplay when opened)
    const vlb = document.getElementById('vidLightbox');
    const vlbVideo = document.getElementById('vlbVideo');
    const vlbClose = document.getElementById('vlbClose');
    const vlbPrev = document.getElementById('vlbPrev');
    const vlbNext = document.getElementById('vlbNext');
    let current = 0;

    function openLightbox(e){
      const btn = e.currentTarget;
      current = parseInt(btn.getAttribute('data-vidindex'), 10) || 0;
      vlbVideo.src = `Media/videos/${files[current]}`;
      vlb.classList.remove('hidden');
      vlb.setAttribute('aria-hidden','false');
      document.body.style.overflow = "hidden";
      vlbVideo.currentTime = 0;
      vlbVideo.play().catch(()=>{});
    }
    function closeLightbox(){
      vlb.classList.add('hidden');
      vlb.setAttribute('aria-hidden','true');
      document.body.style.overflow = "";
      vlbVideo.pause();
      vlbVideo.src = "";
    }
    function show(delta){
      current = (current + delta + files.length) % files.length;
      vlbVideo.src = `Media/videos/${files[current]}`;
      vlbVideo.currentTime = 0;
      vlbVideo.play().catch(()=>{});
    }
    vlbClose.addEventListener('click', closeLightbox);
    vlb.addEventListener('click', (e)=>{ if(e.target === vlb || e.target.classList.contains('bg-black/90')) closeLightbox(); });
    vlbPrev.addEventListener('click', ()=>show(-1));
    vlbNext.addEventListener('click', ()=>show(1));
    window.addEventListener('keydown', (e)=>{
      if (!vlb.classList.contains('hidden')) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') show(-1);
        if (e.key === 'ArrowRight') show(1);
      }
    });

    toggleBtn.addEventListener('click', ()=>{
      expanded = !expanded;
      render();
    });

    // Init
    try {
      files = await loadListTxt(); // expects Media/videos/List.txt
      if (!files.length){
        document.getElementById('videos').classList.add('hidden');
        return;
      }
      render();
    } catch (err) {
      console.warn('[Videos] ' + err.message);
      document.getElementById('videos').classList.add('hidden');
    }
  })();

  /* ================= CENTERED-ITEM "ACTIVE" LOGIC =================
     On mobile (<= 639px, 1-column grids), the single item nearest the
     viewport center in each grid gets class 'active'. If it's a video
     card, we also auto-preview it; all other videos are paused/reset.
  ================================================================== */
  (function(){
    const gallery = document.getElementById('gallery');
    const videoGrid = document.getElementById('videoGrid');

    let ticking = false;

    function isOneColumn(){ return window.matchMedia('(max-width: 639px)').matches; }

    function setActive(container){
      if (!container) return;
      const items = Array.from(container.children);
      if (!items.length) return;

      // Clear previous active classes
      items.forEach(el => el.classList.remove('active'));

      // Find item whose center is closest to viewport center
      const vy = window.innerHeight / 2;
      let best = null, bestDist = Infinity;
      for (const el of items){
        const r = el.getBoundingClientRect();
        if (r.height <= 0 || r.bottom < 0 || r.top > window.innerHeight) continue;
        const cy = (r.top + r.bottom) / 2;
        const d = Math.abs(cy - vy);
        if (d < bestDist){ bestDist = d; best = el; }
      }
      if (!best) return;

      best.classList.add('active');

      // If this grid is the videos grid, auto-preview the centered one and pause others.
      if (container === videoGrid){
        for (const el of items){
          const v = el.querySelector('video');
          if (!v) continue;
          if (el === best){
            v.play().catch(()=>{});
          } else {
            v.pause(); try { v.currentTime = 0; } catch(_) {}
          }
        }
      }
    }

    function refreshActiveCentered(){
      if (!isOneColumn()){
        // On wider screens, remove 'active' and ensure videos only play on hover.
        [gallery, videoGrid].forEach(container=>{
          if (!container) return;
          const items = Array.from(container.children);
          items.forEach(el => {
            el.classList.remove('active');
            const v = el.querySelector('video');
            if (v){ v.pause(); try { v.currentTime = 0; } catch(_) {} }
          });
        });
        return;
      }
      setActive(gallery);
      setActive(videoGrid);
    }

    function onScrollOrResize(){
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(()=>{
        refreshActiveCentered();
        ticking = false;
      });
    }

    window.addEventListener('scroll', onScrollOrResize, { passive:true });
    window.addEventListener('resize', onScrollOrResize, { passive:true });
    window.addEventListener('orientationchange', onScrollOrResize);

    // Expose so renderers can call after DOM updates
    window.refreshActiveCentered = refreshActiveCentered;
  })();
</script>
</body>
</html>
